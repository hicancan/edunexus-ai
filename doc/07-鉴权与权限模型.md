# EduNexus AI 鉴权与权限模型

## 1. 文档目标
定义统一的认证（Authentication）与授权（Authorization）机制，保证“谁登录、能访问什么、能操作谁的数据”具备确定规则。

## 2. 认证模型

## 2.1 凭证类型

1. Access Token（JWT，短期）
2. Refresh Token（长期，存哈希）

## 2.2 JWT Claims 约定

| Claim | 含义 |
|---|---|
| `sub` | 用户 ID |
| `username` | 用户名 |
| `role` | STUDENT/TEACHER/ADMIN |
| `status` | ACTIVE/DISABLED |
| `iat` | 签发时间 |
| `exp` | 过期时间 |
| `jti` | token 唯一 ID |

## 2.3 登录与刷新

1. 登录成功返回 `accessToken + refreshToken + user`。
2. 刷新 token 采用轮换策略（refresh rotation）：每次刷新生成新 refresh token，旧 token 立即失效。
3. 退出登录时应吊销当前 refresh token。

## 3. 授权模型（RBAC + 资源归属）

## 3.1 角色权限边界

- STUDENT：只能访问自己的学习数据。
- TEACHER：管理自己的文档与教案，可查看授权学生学情并写建议。
- ADMIN：平台治理权限，但不得直接绕过业务规则篡改关键记录。

## 3.2 资源归属校验（必须）

1. 聊天会话：`chat_sessions.student_id == currentUser.id`
2. 练习记录：`exercise_records.student_id == currentUser.id`
3. 错题条目：`wrong_book.student_id == currentUser.id`
4. AI 出题会话：`ai_question_sessions.student_id == currentUser.id`
5. 知识文档：`documents.teacher_id == currentUser.id`
6. 教案：`lesson_plans.teacher_id == currentUser.id`

任何归属校验失败返回 403。

## 4. 接口权限矩阵

| 接口 | STUDENT | TEACHER | ADMIN |
|---|---|---|---|
| `POST /auth/register` | ✅ | ✅ | ❌ |
| `POST /auth/login` | ✅ | ✅ | ✅ |
| `POST /auth/logout` | ✅ | ✅ | ✅ |
| `GET /auth/me` | ✅ | ✅ | ✅ |
| `POST /student/chat/session` | ✅ | ❌ | ❌ |
| `GET /student/chat/sessions` | ✅ | ❌ | ❌ |
| `POST /student/exercise/submit` | ✅ | ❌ | ❌ |
| `GET /student/ai-questions` | ✅ | ❌ | ❌ |
| `POST /teacher/knowledge/documents` | ❌ | ✅ | ❌ |
| `POST /teacher/plans/generate` | ❌ | ✅ | ❌ |
| `POST /teacher/plans/{planId}/share` | ❌ | ✅ | ❌ |
| `GET /teacher/plans/shared/{shareToken}` | ✅（匿名可选） | ✅ | ✅ |
| `GET /teacher/students/{studentId}/analytics` | ❌ | ✅ | ❌ |
| `POST /teacher/suggestions` | ❌ | ✅ | ❌ |
| `GET /admin/users` | ❌ | ❌ | ✅ |
| `PATCH /admin/users/{userId}` | ❌ | ❌ | ✅ |
| `GET /admin/dashboard/metrics` | ❌ | ❌ | ✅ |

## 5. 中间件/拦截器执行顺序

1. 解析 token（失败 -> 401）
2. 校验 token 有效期与签名（失败 -> 401）
3. 校验用户状态 ACTIVE（否则 -> 403）
4. 校验角色是否具备接口权限（否则 -> 403）
5. 执行资源归属校验（否则 -> 403）
6. 执行业务逻辑

## 6. 错误语义规范

- `401 Unauthorized`：未登录、token 无效、token 过期。
- `403 Forbidden`：已登录但无角色权限或归属权限。
- `404 Not Found`：资源不存在（在不泄露资源存在性的场景中，可将 403 统一回 404）。

## 7. 安全要求

> 本章是安全规则的唯一权威源。其他文档（05/10）若涉及安全规则，应引用本文。

1. 密码仅存哈希（Bcrypt/Argon2）。
2. refresh token 仅存哈希，不存明文。
3. 日志禁止输出密码、token、完整个人隐私字段。
4. 高危接口（角色变更、资源下载）必须写审计日志。
5. 管理员下载操作必须有审计记录。

---
文档状态：`v1.1.0`（2026-02-26 标注安全规则唯一源声明）
