# EduNexus AI 数据模型与迁移规范

## 1. 技术选型与数据分层

1. 事务数据：PostgreSQL 17（主业务库）
2. 向量检索：Qdrant 1.17（RAG 向量库）
3. 缓存/会话：Redis 7.2 LTS
4. 对象存储：MinIO（S3 兼容）

## 2. 建模总原则

1. 所有主键使用 `UUID`。
2. 时间字段统一 `TIMESTAMPTZ`。
3. 关键表支持软删除（`deleted_at`）。
4. 枚举值通过 `CHECK` 或 `ENUM` 约束。
5. 明细数据优先拆表，避免把核心业务长期塞入 JSON。

## 3. PostgreSQL 表结构

## 3.1 身份认证

### `users`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 用户 ID |
| username | VARCHAR(50) | UNIQUE NOT NULL | 登录名 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| email | VARCHAR(100) | NULL | 邮箱 |
| phone | VARCHAR(20) | NULL | 手机号 |
| role | VARCHAR(20) | NOT NULL | STUDENT/TEACHER/ADMIN |
| status | VARCHAR(20) | NOT NULL DEFAULT 'ACTIVE' | ACTIVE/DISABLED |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMPTZ | NULL | 软删除时间 |

### `refresh_tokens`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | token 记录 ID |
| user_id | UUID | FK -> users.id | 用户 |
| token_hash | VARCHAR(255) | NOT NULL | refresh token 哈希 |
| expires_at | TIMESTAMPTZ | NOT NULL | 过期时间 |
| revoked_at | TIMESTAMPTZ | NULL | 吊销时间 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |

## 3.2 聊天与 RAG 问答

### `chat_sessions`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 会话 ID |
| student_id | UUID | FK -> users.id | 会话归属学生 |
| title | VARCHAR(120) | NOT NULL DEFAULT '新建对话' | 会话标题 |
| is_deleted | BOOLEAN | NOT NULL DEFAULT false | 软删除标记 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMPTZ | NULL | 删除时间 |

### `chat_messages`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 消息 ID |
| session_id | UUID | FK -> chat_sessions.id | 会话 ID |
| role | VARCHAR(20) | NOT NULL | USER/ASSISTANT |
| content | TEXT | NOT NULL | 消息正文 |
| citations | JSONB | NULL | 引用片段信息 |
| token_usage | INT | NOT NULL DEFAULT 0 | token 消耗 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 消息时间 |

## 3.3 练习与错题

### `questions`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 题目 ID |
| subject | VARCHAR(50) | NOT NULL | 科目 |
| question_type | VARCHAR(30) | NOT NULL | SINGLE_CHOICE/MULTIPLE_CHOICE/TRUE_FALSE/SHORT_ANSWER |
| difficulty | VARCHAR(20) | NOT NULL | EASY/MEDIUM/HARD |
| content | TEXT | NOT NULL | 题干 |
| options | JSONB | NULL | 选项 |
| correct_answer | TEXT | NOT NULL | 正确答案 |
| analysis | TEXT | NULL | 标准解析 |
| knowledge_points | JSONB | NULL | 知识点数组 |
| score | INT | NOT NULL DEFAULT 5 | 题目分值 |
| source | VARCHAR(20) | NOT NULL DEFAULT 'MANUAL' | MANUAL/AI_GENERATED |
| ai_session_id | UUID | NULL | 若为 AI 生成题，关联会话 |
| created_by | UUID | FK -> users.id | 创建者 |
| is_active | BOOLEAN | NOT NULL DEFAULT true | 启用状态 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

### `exercise_records`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 作答记录 ID |
| student_id | UUID | FK -> users.id | 学生 |
| subject | VARCHAR(50) | NULL | 科目 |
| total_questions | INT | NOT NULL | 总题数 |
| correct_count | INT | NOT NULL | 正确数 |
| total_score | INT | NOT NULL | 总分 |
| time_spent | INT | NOT NULL DEFAULT 0 | 耗时（秒） |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 提交时间 |

### `exercise_record_items`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 明细 ID |
| record_id | UUID | FK -> exercise_records.id | 作答记录 |
| question_id | UUID | FK -> questions.id | 题目 |
| user_answer | TEXT | NOT NULL | 学生答案 |
| correct_answer | TEXT | NOT NULL | 标准答案 |
| is_correct | BOOLEAN | NOT NULL | 是否正确 |
| score | INT | NOT NULL | 本题得分 |
| analysis | TEXT | NULL | 本题解析快照 |
| teacher_suggestion | TEXT | NULL | 教师建议快照 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 记录时间 |

### `wrong_book`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 错题记录 ID |
| student_id | UUID | FK -> users.id | 学生 |
| question_id | UUID | FK -> questions.id | 题目 |
| wrong_count | INT | NOT NULL DEFAULT 1 | 错误次数 |
| last_wrong_time | TIMESTAMPTZ | NOT NULL DEFAULT now() | 最后错误时间 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'ACTIVE' | ACTIVE/MASTERED |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

唯一约束：`UNIQUE(student_id, question_id)`。

## 3.4 AI 个性化出题

### `ai_question_sessions`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | AI 出题会话 ID |
| student_id | UUID | FK -> users.id | 学生 |
| subject | VARCHAR(50) | NOT NULL | 科目 |
| difficulty | VARCHAR(20) | NULL | 难度 |
| question_count | INT | NOT NULL | 题目数量 |
| completed | BOOLEAN | NOT NULL DEFAULT false | 是否完成 |
| correct_rate | NUMERIC(5,2) | NULL | 正确率（0-100） |
| score | INT | NULL | 总分 |
| context_snapshot | JSONB | NULL | 生成时上下文快照 |
| generated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 生成时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

### `ai_question_records`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 作答记录 ID |
| session_id | UUID | FK -> ai_question_sessions.id | 归属会话 |
| student_id | UUID | FK -> users.id | 学生 |
| total_questions | INT | NOT NULL | 总题数 |
| correct_count | INT | NOT NULL | 正确数 |
| total_score | INT | NOT NULL | 总分 |
| submitted_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 提交时间 |

### `ai_question_record_items`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 明细 ID |
| record_id | UUID | FK -> ai_question_records.id | 记录 |
| question_id | UUID | FK -> questions.id | 题目 |
| user_answer | TEXT | NOT NULL | 学生答案 |
| correct_answer | TEXT | NOT NULL | 正确答案 |
| is_correct | BOOLEAN | NOT NULL | 是否正确 |
| score | INT | NOT NULL | 本题得分 |
| analysis | TEXT | NULL | 本题解析 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |

## 3.5 教师与管理

### `documents`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 文档 ID |
| teacher_id | UUID | FK -> users.id | 上传教师 |
| filename | VARCHAR(255) | NOT NULL | 文件名 |
| file_type | VARCHAR(100) | NOT NULL | MIME 类型 |
| file_size | BIGINT | NOT NULL | 文件大小（字节） |
| storage_path | VARCHAR(512) | NOT NULL | MinIO/S3 路径 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'UPLOADING' | UPLOADING/PARSING/EMBEDDING/READY/FAILED |
| error_message | TEXT | NULL | 失败原因 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 上传时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMPTZ | NULL | 软删除时间 |

### `lesson_plans`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 教案 ID |
| teacher_id | UUID | FK -> users.id | 教师 |
| topic | VARCHAR(255) | NOT NULL | 主题 |
| grade_level | VARCHAR(50) | NOT NULL | 年级 |
| duration_mins | INT | NOT NULL | 课时 |
| content_md | TEXT | NOT NULL | Markdown 内容 |
| is_shared | BOOLEAN | NOT NULL DEFAULT false | 是否已分享 |
| share_token | VARCHAR(64) | NULL UNIQUE | 分享令牌 |
| shared_at | TIMESTAMPTZ | NULL | 分享时间 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMPTZ | NULL | 软删除 |

### `teacher_suggestions`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 建议 ID |
| teacher_id | UUID | FK -> users.id | 教师 |
| student_id | UUID | FK -> users.id | 学生 |
| question_id | UUID | FK -> questions.id, NULL | 可选绑定题目 |
| knowledge_point | VARCHAR(100) | NULL | 可选绑定知识点 |
| suggestion | TEXT | NOT NULL | 建议内容 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

### `audit_logs`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 日志 ID |
| actor_id | UUID | FK -> users.id | 操作者 |
| actor_role | VARCHAR(20) | NOT NULL | 操作者角色 |
| action | VARCHAR(120) | NOT NULL | 动作名称 |
| resource_type | VARCHAR(80) | NOT NULL | 资源类型 |
| resource_id | VARCHAR(80) | NOT NULL | 资源主键 |
| detail | JSONB | NULL | 详情快照 |
| ip | VARCHAR(64) | NULL | 源 IP |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 操作时间 |

## 3.6 教学授权与平台保障

### `classrooms`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 班级 ID |
| name | VARCHAR(120) | NOT NULL | 班级名称 |
| teacher_id | UUID | FK -> users.id | 班级负责人教师 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'ACTIVE' | ACTIVE/ARCHIVED |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

### `teacher_student_bindings`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 绑定 ID |
| teacher_id | UUID | FK -> users.id | 教师 |
| student_id | UUID | FK -> users.id | 学生 |
| classroom_id | UUID | FK -> classrooms.id, NULL | 可选班级作用域 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'PENDING' | PENDING/ACTIVE/REVOKED |
| effective_from | TIMESTAMPTZ | NULL | 生效时间 |
| revoked_at | TIMESTAMPTZ | NULL | 撤销时间 |
| created_by | UUID | FK -> users.id | 创建人 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

唯一约束建议：使用**部分唯一索引**确保仅一条生效绑定，例如：

- `UNIQUE(teacher_id, student_id, classroom_id) WHERE status = 'ACTIVE'`

### `job_runs`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 任务执行 ID |
| job_type | VARCHAR(50) | NOT NULL | DOCUMENT_PARSE/EMBEDDING/RAG_REINDEX/... |
| business_id | UUID | NULL | 业务主键（如 document_id） |
| status | VARCHAR(20) | NOT NULL | PENDING/RUNNING/SUCCEEDED/FAILED/DEAD_LETTER |
| attempt | INT | NOT NULL DEFAULT 1 | 第几次尝试 |
| payload | JSONB | NULL | 输入快照 |
| result | JSONB | NULL | 输出快照 |
| error_message | TEXT | NULL | 错误信息 |
| started_at | TIMESTAMPTZ | NULL | 开始时间 |
| finished_at | TIMESTAMPTZ | NULL | 结束时间 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 更新时间 |

### `idempotency_keys`

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | UUID | PK | 主键 |
| scope | VARCHAR(80) | NOT NULL | 业务作用域（如 `exercise.submit`） |
| idem_key | VARCHAR(128) | NOT NULL | 幂等键 |
| request_hash | VARCHAR(128) | NOT NULL | 请求内容哈希 |
| response_snapshot | JSONB | NULL | 首次处理响应快照 |
| expires_at | TIMESTAMPTZ | NOT NULL | 过期时间 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT now() | 创建时间 |

唯一约束：`UNIQUE(scope, idem_key)`。

## 4. Qdrant 向量模型

集合：`knowledge_chunks`

- 向量模型：`qwen3-embedding:0.6b`（Ollama），输出维度默认 1024
- 距离函数：Cosine Similarity

| 字段 | 类型 | 说明 |
|---|---|---|
| id | UUID | chunk 主键 |
| vector | Float[1024] | 嵌入向量（qwen3-embedding 输出） |
| payload.document_id | UUID | 对应 `documents.id` |
| payload.teacher_id | UUID | 教师隔离键 |
| payload.class_id | String/UUID | 班级隔离键（可选） |
| payload.filename | String | 文件名 |
| payload.chunk_index | Int | chunk 顺序 |
| payload.page_number | Int | 页码（可选） |
| payload.content | String | 分块文本 |
| payload.content_hash | String | 去重哈希 |

检索必须先按 `teacher_id` 或 `class_id` 过滤，再做相似度召回。

## 5. 索引规范

建议索引：

1. `users(username)` 唯一索引。
2. `chat_sessions(student_id, updated_at desc)`。
3. `chat_messages(session_id, created_at)`。
4. `exercise_records(student_id, created_at desc)`。
5. `wrong_book(student_id, status, last_wrong_time desc)`。
6. `ai_question_sessions(student_id, generated_at desc)`。
7. `documents(teacher_id, status, created_at desc)`。
8. `lesson_plans(teacher_id, updated_at desc)`。
9. `audit_logs(actor_id, created_at desc)`。
10. `teacher_student_bindings(teacher_id, student_id, status)`。
11. `teacher_student_bindings(student_id, status)`。
12. `job_runs(job_type, status, created_at desc)`。
13. `idempotency_keys(scope, idem_key)` 唯一索引。

## 6. 迁移规范（Flyway）

1. 迁移命名：`VYYYYMMDDHHMM__desc.sql`。
2. 先加后删：禁止直接删列导致生产不可逆。
3. 每个破坏性变更必须有回滚脚本或补偿脚本。
4. 同一 PR 内迁移脚本不可修改历史版本文件，只能新增。
5. 迁移完成后必须同步更新本文件与 `06-API契约-openapi.yaml`。

## 7. 数据一致性规则

1. 提交练习时：`exercise_records` 与 `exercise_record_items` 同事务写入。
2. 自动错题同步：判分后在同业务事务内更新 `wrong_book`。
3. 文档删除：先标记 `documents.deleted_at`，再异步删除 Qdrant chunks。
4. AI 出题提交：写入 record 后回写 session 的 `completed/correct_rate/score`。
5. 教师查看学情前必须校验 `teacher_student_bindings.status = ACTIVE`。
6. 异步任务必须记录 `job_runs`，失败重试与死信状态可追溯。
7. 关键写接口（提交答案、生成题、上传文档）应支持幂等键防重。

## 8. 数据安全规范

安全规则的完整定义见 `07-鉴权与权限模型.md`（安全规则唯一源）。

数据层核心约束：
1. 密码字段 `password_hash` 仅存哈希，不存明文。
2. token 字段 `token_hash` 仅存哈希。
3. 审计日志 `detail` 字段禁止写入密码/token/完整隐私信息。

---
文档状态：`v1.2.0`（2026-02-26 新增教学授权关系、异步任务与幂等键模型）
