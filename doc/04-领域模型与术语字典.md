# EduNexus AI 领域模型与术语字典

## 1. 文档目标
统一业务概念、实体边界、状态机与术语，避免开发、产品、算法、前端在同一概念上产生不同理解。

## 2. 领域划分

## 2.1 Identity（身份域）

- 核心实体：`User`、`RefreshTokenSession`
- 职责：注册、登录、身份识别、角色分配
- 关键不变量：
  1. `username` 全局唯一。
  2. `role` 必须在 `STUDENT/TEACHER/ADMIN` 内。
  3. 禁用用户（DISABLED）不可访问受保护接口。

## 2.2 Conversation（问答会话域）

- 核心实体：`ChatSession`、`ChatMessage`
- 职责：学生与 AI 对话管理
- 关键不变量：
  1. 会话必须归属某个学生。
  2. 消息必须归属会话。
  3. 会话删除采用软删除。
  4. 首条用户消息产生会话标题。

## 2.3 Exercise（练习域）

- 核心实体：`Question`、`ExerciseRecord`、`ExerciseRecordItem`
- 职责：题目分发、答案提交、自动判分、解析
- 关键不变量：
  1. 记录头（record）与明细（items）必须同事务写入。
  2. 明细必须包含用户答案、正确答案、是否正确、得分。
  3. 错题自动同步到 WrongBook。

## 2.4 WrongBook（错题域）

- 核心实体：`WrongBookEntry`
- 职责：错题复习与掌握状态管理
- 关键不变量：
  1. 同一学生 + 同一题目仅保留一条 ACTIVE 记录。
  2. 错误次数 `wrong_count` 累加。
  3. 移除行为本质为状态更新（MASTERED）。

## 2.5 AIQuestioning（AI 出题域）

- 核心实体：`AIQuestionSession`、`AIQuestionRecord`、`AIQuestionRecordItem`
- 职责：动态出题、提交、解析、历史统计
- 关键不变量：
  1. 每次生成必须产生独立 session。
  2. 生成题目必须持久化并标记来源 `AI_GENERATED`。
  3. 会话统计字段（correctRate/score/completed）由记录计算得出。

## 2.6 KnowledgeBase（知识库域）

- 核心实体：`Document`、`KnowledgeChunk`（Qdrant）
- 职责：文档上传、切分、向量化、检索
- 关键不变量：
  1. 文档与教师强绑定。
  2. 向量检索必须包含 `teacher_id` 或 `class_id` 过滤。
  3. 删除文档必须同步删除向量 chunks。

## 2.7 TeachingResource（教学资源域）

- 核心实体：`LessonPlan`、`TeacherSuggestion`
- 职责：教案生成与教师建议反馈
- 关键不变量：
  1. 建议必须指向学生与题目或知识点。
  2. 建议可被学生解析与 AI 出题上下文消费。
  3. 教案分享必须生成可撤销的 `share_token`。

## 2.8 AdminGovernance（治理域）

- 核心实体：`AdminAuditLog`
- 职责：用户治理、资源治理、平台统计
- 关键不变量：
  1. 管理员操作应记录审计日志。
  2. 下载类操作可追踪到操作者。

## 3. 关键状态机

> 本章是状态机的唯一权威源。其他文档（05/08）若涉及状态机，应引用本文。

## 3.1 文档处理状态

`UPLOADING -> PARSING -> EMBEDDING -> READY`

异常路径：任意阶段失败 -> `FAILED`（记录 `error_message`）。

## 3.2 错题状态

`ACTIVE -> MASTERED`

可选回流：若再次答错同题，可将 MASTERED 重新激活为 ACTIVE 并更新次数。

## 3.3 AI 出题会话状态

`GENERATED -> ANSWERED -> ANALYZED`

当提交后写入 score/correctRate，并将 `completed=true`。

## 4. 术语字典

| 术语 | 英文 | 定义 |
|---|---|---|
| 会话 | Session | 一次连续交互容器（聊天或 AI 出题） |
| 记录 | Record | 一次提交行为的结果载体 |
| 明细 | Item | 记录中的单题粒度数据 |
| 错题本 | Wrong Book | 学生错题集合及复习状态 |
| 知识库 | Knowledge Base | 教师上传并可被检索的私有教学资料 |
| 分块 | Chunk | 文档切分后的最小检索单元 |
| 引用 | Citation | AI 回答中标注的来源片段 |
| 归属校验 | Ownership Check | 验证资源是否属于当前用户 |
| 软删除 | Soft Delete | 逻辑删除，数据仍保留 |

## 5. 枚举约定

> 本章是枚举值的唯一权威源。其他文档（01/05/06）若涉及枚举，应引用本文。

1. 用户角色：`STUDENT`、`TEACHER`、`ADMIN`
2. 用户状态：`ACTIVE`、`DISABLED`
3. 题目难度：`EASY`、`MEDIUM`、`HARD`
4. 题目类型：`SINGLE_CHOICE`、`MULTIPLE_CHOICE`、`TRUE_FALSE`、`SHORT_ANSWER`
5. 题目来源：`MANUAL`、`AI_GENERATED`
6. 消息角色：`USER`、`ASSISTANT`

## 6. 领域约束总览

1. 身份域是所有域的前置依赖。
2. 会话域、练习域、AI 出题域都依赖归属校验。
3. AI 能力不是独立业务，必须服务于聊天/解析/出题/教案四个业务触点。
4. 管理域不应绕过业务约束直接改动核心记录，必须通过受控接口。

---
文档状态：`v1.1.0`（2026-02-26 标注枚举/状态机唯一源声明）
