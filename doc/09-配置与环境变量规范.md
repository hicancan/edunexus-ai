# EduNexus AI 配置与环境变量规范

## 1. 文档目标
定义 `.env` 配置的统一语义、必填项和环境切换规则，避免“能启动但行为不一致”的问题。

## 2. 配置原则

1. 配置与代码分离，不在代码中硬编码密钥。
2. 每个变量必须有用途说明、默认值与是否必填。
3. `LLM_PROVIDER` 是模型路由总开关。
4. Demo 环境允许本地默认值，但线上必须替换弱密码与占位符。

## 3. 环境变量清单

## 3.1 应用基础

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `APP_ENV` | 运行环境 | 是 | `local` |
| `APP_PORT` | 业务后端端口 | 是 | `8080` |
| `AI_SERVICE_PORT` | AI 服务端口 | 是 | `8000` |
| `WEB_PORT` | 前端端口 | 是 | `5173` |

## 3.2 PostgreSQL

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `POSTGRES_HOST` | 数据库主机 | 是 | `127.0.0.1` |
| `POSTGRES_PORT` | 端口 | 是 | `5432` |
| `POSTGRES_DB` | 数据库名 | 是 | `edunexus` |
| `POSTGRES_USER` | 用户名 | 是 | `postgres` |
| `POSTGRES_PASSWORD` | 密码 | 是 | `postgres` |
| `DATABASE_URL` | 连接串 | 是 | `postgresql://...` |

## 3.3 Redis

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `REDIS_HOST` | Redis 主机 | 是 | `127.0.0.1` |
| `REDIS_PORT` | Redis 端口 | 是 | `6379` |
| `REDIS_URL` | Redis 连接串 | 是 | `redis://127.0.0.1:6379/0` |

## 3.4 Qdrant

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `QDRANT_HOST` | Qdrant 主机 | 是 | `127.0.0.1` |
| `QDRANT_PORT` | 端口 | 是 | `6333` |
| `QDRANT_URL` | HTTP 地址 | 是 | `http://127.0.0.1:6333` |
| `QDRANT_API_KEY` | API Key（云端） | 否 | 空 |

## 3.5 MinIO / S3

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `S3_ENDPOINT` | 对象存储地址 | 是 | `http://127.0.0.1:9000` |
| `S3_REGION` | 区域 | 是 | `us-east-1` |
| `S3_ACCESS_KEY` | Access Key | 是 | `minioadmin` |
| `S3_SECRET_KEY` | Secret Key | 是 | `minioadmin` |
| `S3_BUCKET` | Bucket 名 | 是 | `edunexus-kb` |
| `S3_FORCE_PATH_STYLE` | 路径风格开关 | 是 | `true` |
| `MINIO_CONSOLE_URL` | MinIO 控制台 | 否 | `http://127.0.0.1:9001` |

## 3.6 鉴权

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `JWT_SECRET` | JWT 签名密钥 | 是 | 强随机字符串 |
| `JWT_EXPIRES_IN` | Access Token 过期时间 | 是 | `15m` |
| `REFRESH_TOKEN_EXPIRES_IN` | Refresh Token 过期时间 | 是 | `14d` |

## 3.7 LLM 路由

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `LLM_PROVIDER` | 模型提供方开关 | 是 | `gemini` / `ollama` / `openai` / `deepseek` |
| `OLLAMA_BASE_URL` | 本地 Ollama 地址 | 当 provider=ollama 时必填 | `http://127.0.0.1:11434` |
| `OLLAMA_MODEL` | 本地模型名 | 当 provider=ollama 时必填 | `deepseek-r1:8b` |
| `GOOGLE_API_KEY` | Google AI Studio 密钥 | 当 provider=gemini 时必填 | `<secret>` |
| `GEMINI_API_KEY` | Gemini 密钥（兼容命名） | 推荐填 | `<secret>` |
| `GEMINI_MODEL` | Gemini 模型名 | 推荐填 | `gemini-2.0-flash` |
| `OPENAI_API_KEY` | OpenAI 密钥 | 当 provider=openai 时必填 | `<secret>` |
| `DEEPSEEK_API_KEY` | DeepSeek 密钥 | 当 provider=deepseek 时必填 | `<secret>` |
| `QWEN_API_KEY` | 备用云模型密钥 | 否 | 空 |
| `ANTHROPIC_API_KEY` | 备用云模型密钥 | 否 | 空 |

## 3.8 可观测

| 变量 | 说明 | 必填 | 示例 |
|---|---|---|---|
| `LOG_LEVEL` | 日志级别 | 是 | `INFO` |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | OTEL 上报地址 | 否 | 空 |

## 4. Provider 切换示例

## 4.1 切到 Gemini（云端）

```env
LLM_PROVIDER=gemini
GOOGLE_API_KEY=<your_google_key>
GEMINI_API_KEY=<your_google_key>
GEMINI_MODEL=gemini-2.0-flash
```

## 4.2 切到 Ollama（本地）

```env
LLM_PROVIDER=ollama
OLLAMA_BASE_URL=http://127.0.0.1:11434
OLLAMA_MODEL=deepseek-r1:8b
```

## 5. 启动顺序

1. 启动基础依赖：PostgreSQL、Redis、Qdrant、MinIO。
2. 启动后端服务（api、ai-service）。
3. 启动前端服务（web）。
4. 访问健康检查与首页。

## 6. 安全注意事项

1. `.env` 不得提交到公开仓库。
2. 任何泄露过的 API Key 必须轮换。
3. `JWT_SECRET` 禁止使用示例值。
4. 生产环境必须使用独立数据库密码与对象存储密钥。

## 7. 最小必填集合（MVP）

- 基础：`APP_ENV`、`APP_PORT`、`AI_SERVICE_PORT`、`WEB_PORT`
- 数据：`DATABASE_URL`、`REDIS_URL`、`QDRANT_URL`
- 存储：`S3_ENDPOINT`、`S3_ACCESS_KEY`、`S3_SECRET_KEY`、`S3_BUCKET`
- 鉴权：`JWT_SECRET`、`JWT_EXPIRES_IN`、`REFRESH_TOKEN_EXPIRES_IN`
- 模型：`LLM_PROVIDER` + 对应 provider 的 key/model

---
文档状态：`v1.0.0`
