# EduNexus AI 内部服务契约与异步任务规范

## 1. 文档目标
定义 API 服务、AI 服务、异步 Worker 之间的调用契约、超时重试、幂等与任务状态模型。

> 本文是**内部服务通信规则唯一源**。`06-API契约-openapi.yaml` 仅定义外部 API。

## 2. 适用范围

1. API -> AI Service 同步调用（聊天、解析、出题、教案）。
2. API/AI -> Worker 异步任务调用（文档解析、切分、向量化、回填状态）。
3. 任务失败重试与死信处理。

## 3. 基础约定

## 3.1 传输协议

- 内部 HTTP：`application/json; charset=utf-8`
- 内部请求必须包含：
  - `X-Trace-Id`
  - `X-Service-Token`（或 mTLS）
  - `Idempotency-Key`（写操作必填）

## 3.2 超时与重试

| 场景 | 超时 | 重试次数 | 重试策略 |
|---|---:|---:|---|
| 聊天 RAG | 25s | 1 | 指数退避 500ms |
| 错题解析 | 30s | 1 | 指数退避 800ms |
| AI 出题 | 45s | 1 | 指数退避 1000ms |
| 教案生成 | 60s | 1 | 指数退避 1200ms |
| 文档处理任务 | 120s/步 | 3 | 指数退避 + 抖动 |

超过最大重试后，任务进入 `DEAD_LETTER`。

## 3.3 错误语义

| 错误码 | HTTP | 含义 |
|---|---|---|
| `INTERNAL_AUTH_FAILED` | 401 | 服务间认证失败 |
| `INTERNAL_FORBIDDEN` | 403 | 服务权限不足 |
| `INTERNAL_TIMEOUT` | 504 | 上游推理超时 |
| `INTERNAL_MODEL_UNAVAILABLE` | 503 | 模型不可用 |
| `INTERNAL_OUTPUT_INVALID` | 502 | 模型输出结构不合法 |
| `INTERNAL_IDEMPOTENT_REPLAY` | 200 | 幂等回放（返回首次结果） |
| `INTERNAL_DEPENDENCY` | 503 | Qdrant/MinIO 等依赖异常 |

## 3.4 Python 运行时强约束

1. AI Service 与 Worker 进程必须运行在 Conda 环境 `edunexus-ai`。
2. AI Service 与 Worker 命令必须通过 `uv` 执行（`uv sync` / `uv run`）。
3. 禁止使用 `pip install` 与 `python xxx.py` 作为运行入口。

## 4. API -> AI Service 同步契约

## 4.1 聊天 RAG

- `POST /internal/v1/rag/chat`

请求体：

```json
{
  "traceId": "trace-xxx",
  "sessionId": "uuid",
  "studentId": "uuid",
  "teacherScope": {
    "teacherId": "uuid",
    "classId": "uuid"
  },
  "message": "用户问题",
  "stream": false,
  "context": {
    "history": [
      {"role": "USER", "content": "..."},
      {"role": "ASSISTANT", "content": "..."}
    ]
  }
}
```

响应体：

```json
{
  "answer": "AI 回复",
  "citations": [
    {
      "documentId": "uuid",
      "filename": "physics_ch3.pdf",
      "chunkIndex": 12,
      "content": "片段",
      "score": 0.92
    }
  ],
  "provider": "ollama",
  "model": "qwen3:8b",
  "tokenUsage": {"prompt": 532, "completion": 311},
  "latencyMs": 1820
}
```

## 4.2 错题解析

- `POST /internal/v1/exercise/analyze`

请求体包含：`question`、`userAnswer`、`correctAnswer`、`knowledgePoints`、`teacherSuggestion`。
响应体包含：`encourage`、`concept`、`steps[]`、`rootCause`、`nextPractice`。

## 4.3 AI 个性化出题

- `POST /internal/v1/aiq/generate`

请求体包含：`studentId`、`count`、`subject`、`difficulty`、`conceptTags`、`weaknessProfile`、`teacherSuggestions`。
响应体必须为结构化题目数组（与 `08` 文档 JSON 输出一致），并附 `routerDecision`（模型路由原因）。

## 4.4 教案生成

- `POST /internal/v1/lesson-plans/generate`

请求体：`topic`、`gradeLevel`、`durationMins`、`teacherId`。
响应体：`contentMd`（固定章节结构）、`provider`、`model`、`latencyMs`。

## 5. 异步任务契约（Worker）

## 5.1 任务模型

任务统一结构：

```json
{
  "jobId": "uuid",
  "jobType": "DOCUMENT_INGEST",
  "traceId": "trace-xxx",
  "businessId": "documentId",
  "attempt": 1,
  "payload": {}
}
```

## 5.2 文档摄取流程任务

1. `DOCUMENT_PARSE`：下载文件并抽取文本。
2. `DOCUMENT_CHUNK`：按 `08` 的 chunk 策略切分。
3. `DOCUMENT_EMBED`：生成向量。
4. `DOCUMENT_UPSERT_QDRANT`：写入向量库。
5. `DOCUMENT_MARK_READY`：回写 `documents.status = READY`。

## 5.3 状态流转

`PENDING -> RUNNING -> SUCCEEDED`

失败路径：

`RUNNING -> FAILED -> (重试) -> RUNNING -> ... -> DEAD_LETTER`

## 5.4 幂等要求

1. 同一 `Idempotency-Key + requestHash` 必须返回首次结果。
2. 文档向量写入以 `document_id + chunk_index + content_hash` 去重。
3. 回写状态是幂等操作，可重复执行不破坏一致性。

## 6. 兼容性策略

1. 内部 API 采用 `/internal/v1/*`，破坏性变更必须升级主版本。
2. 新增字段默认向后兼容（仅追加，禁止改语义）。
3. 删除字段需至少经历 1 个 minor 周期并给出去除公告。

## 7. 观测与审计

每次内部调用必须记录：

- traceId
- caller/service
- endpoint
- provider/model（若涉及 AI）
- latencyMs
- status
- retryCount

任务日志必须可关联到 `job_runs.id` 与 `documents.id`。

## 8. 与其它文档的关系

1. 外部接口定义：见 `06-API契约-openapi.yaml`。
2. AI 推理策略：见 `08-AI与RAG策略.md`。
3. 数据表与任务持久化：见 `05-数据模型与迁移规范.md`。
4. 验收与门禁：见 `11` 与 `13`。

---
文档状态：`v1.1.0`（2026-02-27 新增 Python 运行时“edunexus-ai + uv”强约束）
