# EduNexus AI 测试策略与质量门禁

## 1. 文档目标
定义可执行的质量标准，让“能跑”升级为“可持续交付”。

> 本文是**质量门禁唯一源**，与 `11-验收清单` 共同构成 DoD。

## 2. 测试金字塔

| 层级 | 目标 | 责任模块 | 通过标准 |
|---|---|---|---|
| Unit | 验证函数/类/规则正确性 | web/api/ai-service | 快速、可重复、无外部依赖 |
| Integration | 验证模块协作 | api + pg/redis、ai + qdrant/minio | 关键路径无协议偏差 |
| Contract | 验证接口兼容性 | 外部 API + 内部服务 API | OpenAPI/内部契约校验通过 |
| E2E | 验证用户主链路 | web + api + ai-service | 关键业务流程全通过 |

## 3. 最低覆盖率阈值

## 3.1 后端（Java）

- 全仓行覆盖率 >= 80%
- 核心领域服务（Auth/Chat/Exercise/AIQ）>= 90%

## 3.2 AI 服务（Python）

- 全仓行覆盖率 >= 80%
- 输出结构化校验、模型路由、RAG 检索核心模块 >= 90%

## 3.3 前端（Vue + TS）

- 业务组件 + store + service 覆盖率 >= 75%
- 核心页面交互（聊天/做题/AI 出题）>= 85%

## 4. PR 门禁（必须全部通过）

1. 格式与静态检查：lint + format check。
2. 类型检查：TypeScript strict + Python 类型检查（pyright/mypy）+ Java 编译检查。
3. 单元与集成测试。
4. 契约测试：
   - 外部 API 与 `06` 保持一致。
   - 内部服务接口与 `12` 保持一致。
5. 安全检查：SAST + SCA + Secret Scan。

任何一项失败，PR 不可合并。

## 5. 发布门禁（Release Gate）

1. 关键 E2E 场景通过：
   - 注册/登录
   - 聊天问答（含引用）
   - 做题提交与错题入库
   - AI 出题提交与解析
   - 教师上传文档与状态流转
2. 数据迁移演练通过（Flyway up/down 或补偿脚本验证）。
3. 安全阻断项为 0：
   - 高危漏洞（CVSS >= 7.0）
   - 明文密钥泄露
4. Python 环境合规：AI 服务运行环境必须是 Conda `edunexus-ai` 且必须使用 `uv`。

## 6. 质量指标与 SLO

| 指标 | 目标 |
|---|---|
| API 成功率（核心接口） | >= 99.5% |
| 聊天首包 P95 | <= 3s |
| 登录接口 P95 | <= 800ms |
| AI 出题 JSON 合法率 | >= 95% |
| 聊天引用率 | >= 85% |

## 7. Python 环境合规检查（强制）

## 7.1 本地开发

1. 执行 AI 服务前，校验 `CONDA_DEFAULT_ENV == edunexus-ai`。
2. 推荐命令：

```bash
conda run -n edunexus-ai uv run --project apps/ai-service pytest
```

## 7.2 CI

1. CI 必须创建独立 Python 环境（conda env 或 `.venv`）。
2. 若环境名不是 `edunexus-ai` 或检测到 `pip/python` 直跑，流水线直接失败并给出错误提示。

## 8. 缺陷分级与处理 SLA

| 级别 | 定义 | 响应时限 | 修复时限 |
|---|---|---|---|
| P0 | 核心链路不可用/安全事故 | 15 分钟 | 24 小时 |
| P1 | 关键功能部分不可用 | 1 小时 | 72 小时 |
| P2 | 非关键功能异常 | 1 工作日 | 1 周 |
| P3 | 体验或文档问题 | 2 工作日 | 排期处理 |

## 9. 回归策略

1. 需求变更必须附带回归范围声明（受影响模块、接口、测试集）。
2. 枚举、状态机、权限规则变更需触发全量契约回归。
3. 模型路由或 Prompt 变更需触发 AI 离线评测回归（见 `08`）。

## 10. 工具建议（2026 实践）

1. 前端：Vitest + Playwright。
2. 后端：JUnit 5 + Testcontainers。
3. Python：pytest + pytest-asyncio + schemathesis（契约）。
4. 安全：CodeQL/Semgrep + Trivy + Gitleaks。

---
文档状态：`v1.1.0`（2026-02-27 Python 合规门禁升级为“edunexus-ai + uv”）
